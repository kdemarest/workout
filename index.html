<html>
<head>
<script
	src="https://code.jquery.com/jquery-3.1.1.js"
	integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
	crossorigin="anonymous"></script>
<script src="http://code.responsivevoice.org/responsivevoice.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.js"></script>

<script>
// To run: node app.js
// Then visit: localhost:4444

let annyangEvents = {
	start: 1,
	soundstart: 1,
	error: 1,
	errorNetwork: 1,
	errorPermissionBlocked: 1,
	errorPermissionDenied: 1,
	end: 1,
	result: 1,
	resultMatch: 1,
	resultNoMatch: 1
};

var listenState = 0;
function say(message) {
	if( typeof message !== 'string' && typeof message !== 'number' ) {
		$('#statusError').html("invalid message ["+message+"]");
		return;
	}
	responsiveVoice.speak(
		''+message,
		"UK English Male",
		{
			onstart: function() {
				annyang.pause();
				listenState = 1;
				$('#statusError').text("listenState="+listenState);
			},
			onend: function() {
				listenState = 0;
				annyang.resume();
				$('#statusError').text("listenState="+listenState);
			},
			onerror: function(arg) {
				$('#statusError').text("speech error: "+arg);
			},
			onpause: function() {
				$('#statusError').text("speech pause");
			},
			onresume: function() {
				$('#statusError').text("speech resume");
			}
		}
	);
}

function run() {
	var state = { index:-1, duration:0, remaining:0, paused: false, text:""};
	function tick() {
		$("#statusListening").html( listenState>0 ? "||" : annyang.isListening() ? "|>" : "-" );
		if( state.paused ) {
			$('#statusPrompt').html("Say 'resume workout' to continue.");
			return;
		}
		if( state.remaining<=0 || state.remaining=='*' ) {
			state.index += 1;
			if( state.index >= list.length ) {
				say("workout complete. Good job.");
				delete handle;
				return;
			}
			var part = list[state.index].split(' ');
			state.duration = part.shift();
			state.remaining = state.duration;
			state.paused = state.remaining == '*';
			state.text = part.join(' ');
			$('#statusText').html(state.text);
			$('#statusPrompt').html(state.remaining);
			say(state.text);
			return;
		}
		state.remaining -= 1;
		$('#statusPrompt').html(state.remaining);
		if( state.remaining <= 5 && state.remaining >= 1 ) {
			say( state.remaining );
		}
	}

	function setPause(newState) {
		if( state.paused != newState ) {
			state.paused = newState;
			say( state.paused ? 'stopping' : 'resuming' );
			tick();
		}
	}

	$(document).keypress(function(event) {
		if( event.which == 32 ) {
			setPause( !state.paused );
		}
	});

	var commands = {
		'resume (workout)': function() {
			setPause(false);
		},
		'pause (workout)': function() {
			setPause(true);
		},
		'stop (workout)': function() {
			setPause(true);
		}
	};
	annyang.addCommands(commands);
	$.each( annyangEvents, function(eventName,value) {
		annyang.addCallback(eventName,function(arg) {
			console.log("A "+eventName+": "+JSON.stringify(arg));
		});
	});
	annyang.start(); //{autoRestart:false, continuous: false});
	annyang.debug(true);

	var workout = $('#workout').text();
	var listRaw = workout.trim().split('\n');
	var list = [];
	var timeTotal = 0;
	$.each(listRaw,function(i,line) {
		if( line.trim() !== '' ) {
			list.push(line);
			var part = line.split(' ',1);
			timeTotal += part[0] == '*' ? 30 : parseInt(part[0]);
		}
	});
	var timeFormatted = new Date(null);
	timeFormatted.setSeconds(timeTotal); // specify value for SECONDS here
	$('#statusTotal').html(timeFormatted.toISOString().substr(11, 8));
	var handle = setInterval(tick,1000);
}

$(document).ready(function() {
	run();
});

</script>
</head>
<body>
<h1>Workout</h1>
<h2 id="statusTotal">
</h2>
<h2 id="statusText">
</h2>
<h2 id="statusPrompt">
</h2>
<h2><span id=statusListening></span><span id="statusHeard"></span>
</h2>
<div id="statusError" style="color:red;">
</div>
<div id="workout" style="display:none;">
* test
10 Start warm up
30 jump rope 
30 jumping jacks
15 prisoner lunge left
15 prisoner lunge right
20 arm rotations clockwise
20 arm rotations counter clockwise
40 torso swings left
40 torso swings right
60 leg scissors horizontal
60 leg scissiors vertical
10 Start workout
* 8 beginner shrimps left
* 8 beginner shrimps right
90 wait
* 8 beginner shrimps left
* 8 beginner shrimps right
90 wait
* 8 beginner shrimps left
* 8 beginner shrimps right
90 wait
* 4 pullups
90 wait
* 4 pullups
90 wait
* 4 pullups
90 wait
* 8 pike diamond pushups
60 wait
* 8 pike diamond pushups
60 wait
* 8 pike diamond pushups
60 wait
* 8 pushups
90 wait
* 8 pushups
90 wait
* 8 pushups
90 wait
* 5 dips
90 wait
* 5 dips
90 wait
* 5 dips
90 wait
* 8 inverted rows bent leg
90 wait
* 8 inverted rows bent leg
90 wait
* 8 inverted rows bent leg
90 wait
45 basic crunches
45 right elbow to knee
45 left elbow to knee
45 ankle reach
45 knees into chest
45 knees left, do right side crunch
45 knees right, do left side crunch
45 push throughs
45 legs to ceiling
45 elbows alternate to knees
30 curls
10 Start Stretching
30 piriformis cross-legged left
30 piriformis cross-legged right
30 piriformis cross-legged left
30 piriformis cross-legged right
30 piriformis cross-legged left
30 piriformis cross-legged right
30 calf
4 pause
30 calf
4 pause
30 calf
4 pause
30 calf bent knee
4 pause
30 calf bent knee
4 pause
30 calf bent knee
4 pause
30 hamstring leg on wall left
4 pause
30 hamstring leg on wall right
4 pause
30 hamstring leg on wall left
4 pause
30 hamstring leg on wall right
4 pause
30 hamstring leg on wall left
4 pause
30 hamstring leg on wall right
4 pause
30 quad
30 groin
30 overhead elbow left
30 overhead elbow right
30 shoulder arm across body
30 neck swivels
10 done!
</div>
</body>
</html>